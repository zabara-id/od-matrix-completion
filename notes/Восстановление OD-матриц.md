## Верхнеуровневое описание

- У нас есть **город как граф**: перекрёстки — вершины, дороги — рёбра.  
- Люди ездят **из зон $i$** в **зоны $j$**. Число поездок «из $i$ в $j$ за час» — элемент **OD-матрицы** $D=\{d_{ij}\}$. Её нужно **восстановить**.
- Что мы **наблюдаем** чаще всего:
  - **счётчики на дорогах** (потоки) $\hat f_e$,
  - иногда **времена проезда**,
  - **априорная** OD-матрица $\hat D$ (опросы, мобильные "следы" и т.п.),
  - **маргиналии**: исходящие $L_i$ (сколько уехало из зоны $i$) и входящие $W_j$ (сколько приехало в зону $j$).

Проблема: **много разных $D$** могут давать **похожие наблюдаемые потоки**. Нужны регуляризация и какие-то структурные ограничения.

---

## Две ситуации

1. ***Без перегрузок.*** Доли распределения по маршрутам почти не зависят от величины потоков. Практическая модель:

   $$
   f \approx A\,d,
   $$

   где $d=\mathrm{vec}(D)$, $f$ — вектор потоков по рёбрам, $A$ — известная матрица маршрутизации. Получаем **линейную** постановку.

2. ***С перегрузками.*** Время на дороге растёт с потоком, пользователи выбирают кратчайшие по времени **маршруты в равновесии**. Связь «$D \to f$» становится **нелинейной**:
   $$
   f(D) \ \text{— результат задачи “назначения” (равновесия)}.
   $$

---

## "Словесная" базовая постановка

Ищем OD-матрицу $D \ge 0$, которая

1) **объясняет** наблюдаемые счётчики (модельные потоки близки к $\hat f$),  
2) **не уходит далеко** от разумного псевдорефернса $\hat D$,  
3) **соблюдает маргиналии** $L, W$,  
4) использует корректную связь «$D \to f$»: линейную $f\approx A d$ или равновесную $f(D)$.

---

## Математическая базовая постановка

Обозначим $f(D)$ — потоки на рёбрах, полученные из $D$ (линейно или через равновесие). Тогда задача:

$$
\begin{aligned}
\min_{D \ge 0}\quad 
& \tfrac12 \bigl\| W^{1/2}\bigl(f(D)-\hat f\bigr)\bigr\|_2^2 
\;+\; \gamma\,\mathrm{KL}\!\left(D\,\middle\|\,\hat D\right) \\
\text{s.t.}\quad 
& D\mathbf 1 = L,\qquad D^\top\mathbf 1 = W.
\end{aligned}
$$

- Первый член — фит к счётчикам (веса $W$ отражают "доверие" к датчикам).  
- Регуляризация $\mathrm{KL}(D\|\hat D)$ — "мягкое" стремление к псевдореференсу:

  $$
  \mathrm{KL}(D\|\hat D)=\sum_{i,j}\left(d_{ij}\,\log\frac{d_{ij}}{\hat d_{ij}} - d_{ij} + \hat d_{ij}\right).
  $$

- Ограничения обеспечивают маргиналии.

**Разница случаев** — только в «чёрном ящике» $f(D)$:
- простой: $f(D)=A\,d$ (линейно);  
- перегруженный: $f(D)$ получается решением задачи равновесного назначения.

---

## Мысли о том, как решать на практике

### Вариант 1. Градиентный наружный цикл + чёрный ящик $f(D)$ (DRAFT)

**Подготовка**
1. Оценить/задать функцию «время на ребре как функция потока» (при перегрузках).
2. Выбрать начальное приближение $D^{(0)}$: взять $\hat D$ или гравитационную модель и **подогнать маргиналии** через IPF (итеративное пропорциональное взвешивание).

**Итерации**
1. Посчитать $f^{(k)}=f\big(D^{(k)}\big)$ (линейно либо заюзать какой-то солвер для нахождения равновесия).
2. Вычислить градиент цели по $D$:
   - **линейный случай:** 
     $$
     \nabla_D \;=\; \mathrm{unvec}\!\big(A^\top W(AD-\hat f)\big) \;+\; \gamma\,\nabla \mathrm{KL}(D\|\hat D),
     $$
     где 
     $$
     \nabla \mathrm{KL}(D\|\hat D) \;=\; \log\!\frac{D}{\hat D}
     $$
     (покомпонентно).
   - **равновесный случай:** к первому слагаемому нужен «косвенный» градиент через чувствительность $\frac{\partial f}{\partial D}$ (неявное дифференцирование условий равновесия; на практике — решение одной линейной подзадачи поверх уже найденного равновесия). См. модель Бекмана, там, скорее всего есть готовые алгоритмы по нахождению этого градиента (Франк-Вульф и т.п.).
3. Сделать шаг по $D$ (адаптивный шаг/Л-БФГС или проксимальный шаг для KL даёт обновление $D$).
4. **Проекция на маргиналии:** два прохода IPF (масштабирование строк и столбцов), ну или что-то типо того.
5. Критерий остановки по стабилизации цели и невязок по счётчикам/маргиналиям.

**Плюсы:** ???.  
**Минусы:** ???.

---

### Вариант 2. Одноуровневая выпуклая постановка

Заменить нижний уровень (назначение) его **условиями оптимальности (KKT)** и решить всё сразу одной прямой-двойственной схемой (ADMM, МФЛ и т.п.). Это избавляет от ручных чувствительностей, но, похоже, расширяет систему ограничений.

**Плюсы:** ???.  
**Минусы:** ???.

---

## Что нужно на вход

**Данные**
- $\hat f$ и веса для датчиков (чем шумнее, тем меньше вес типо, например),
- псевдореференс $\hat D$ и/или маргиналии $L, W$,
- параметры функции «время от потока» (для перегруженного случая).

**Гиперпараметры**
- $\gamma>0$ — сила доверия к $\hat{D}$,
- (опционально) замена L2 на робастную функцию если есть выбросы.

**Валидация**
- Отложить часть датчиков, проверять качество предсказаний,
- Бутстрэп по датчикам для оценки неопределённости в $D$.

---

## Первая итерация постановки для решения (без перегрузок)

Предположим, что есть матрица маршрутизации $A$. Тогда:

$$
\begin{aligned}
\min_{D\ge 0}\quad 
& \tfrac12\|W^{1/2}(A\,d-\hat f)\|_2^2 + \gamma\,\mathrm{KL}(D\|\hat D) \\
\text{s.t.}\quad 
& D\mathbf 1=L,\qquad D^\top\mathbf 1=W,\qquad d=\mathrm{vec}(D).
\end{aligned}
$$

Решение: градиент $A^\top W(Ad-\hat f)$, проксимальный шаг KL (мультипликативный апдейт (?)), затем IPF-проекция на маргиналии. Похоже, это может быть быстро и просто, подойдет для того, чтобы выработать базу под более сложные постановки.
